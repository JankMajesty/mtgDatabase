<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Card Database - Advanced Search</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .search-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-header i {
            font-size: 1.5rem;
        }

        .search-content {
            padding: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .filter-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .filter-group h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group h3 i {
            color: #6c757d;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .multi-select {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .multi-select label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .multi-select label:hover {
            background-color: #f8f9fa;
        }

        .multi-select input[type="checkbox"] {
            margin-right: 8px;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .range-inputs input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .results-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-count {
            font-size: 1.1rem;
            color: #495057;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-content {
            padding: 20px;
        }

        .card-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #212529;
        }

        .card-mana {
            color: #6c757d;
            margin-bottom: 8px;
            font-family: monospace;
        }

        .card-type {
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .card-set {
            color: #6c757d;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .card-rarity {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .rarity-common { background: #e9ecef; color: #495057; }
        .rarity-uncommon { background: #d4edda; color: #155724; }
        .rarity-rare { background: #cce5ff; color: #004085; }
        .rarity-mythic { background: #f8d7da; color: #721c24; }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .sql-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            white-space: pre-wrap;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover {
            background: #e9ecef;
        }

        .pagination button.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
            
            .range-inputs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function MTGSearchApp() {
            const [filters, setFilters] = useState({
                card_name: '',
                sets: [],
                colors: [],
                rarities: [],
                card_types: [],
                subtypes: [],
                artists: [],
                cmc_min: '',
                cmc_max: '',
                power_min: '',
                power_max: '',
                toughness_min: '',
                toughness_max: '',
                limit: 100
            });

            const [availableFilters, setAvailableFilters] = useState({});
            const [searchResults, setSearchResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [totalResults, setTotalResults] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [showSqlPreview, setShowSqlPreview] = useState(false);

            useEffect(() => {
                loadFilters();
            }, []);

            const loadFilters = async () => {
                try {
                    const response = await fetch('/api/filters');
                    const data = await response.json();
                    if (data.success) {
                        setAvailableFilters(data.filters);
                    }
                } catch (err) {
                    setError('Failed to load filter options');
                }
            };

            const handleFilterChange = (filterType, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterType]: value
                }));
            };

            const handleMultiSelectChange = (filterType, value, checked) => {
                setFilters(prev => ({
                    ...prev,
                    [filterType]: checked 
                        ? [...prev[filterType], value]
                        : prev[filterType].filter(item => item !== value)
                }));
            };

            const performSearch = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(filters)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setSearchResults(data.cards);
                        setTotalResults(data.total);
                        setCurrentPage(1);
                    } else {
                        setError(data.error || 'Search failed');
                    }
                } catch (err) {
                    setError('Network error occurred');
                } finally {
                    setLoading(false);
                }
            };

            const clearFilters = () => {
                setFilters({
                    card_name: '',
                    sets: [],
                    colors: [],
                    rarities: [],
                    card_types: [],
                    subtypes: [],
                    artists: [],
                    cmc_min: '',
                    cmc_max: '',
                    power_min: '',
                    power_max: '',
                    toughness_min: '',
                    toughness_max: '',
                    limit: 100
                });
                setSearchResults([]);
                setTotalResults(0);
                setError(null);
            };

            const getRarityClass = (rarity) => {
                const rarityLower = rarity.toLowerCase();
                if (rarityLower.includes('mythic')) return 'rarity-mythic';
                if (rarityLower.includes('rare')) return 'rarity-rare';
                if (rarityLower.includes('uncommon')) return 'rarity-uncommon';
                return 'rarity-common';
            };

            const formatManaCost = (manaCost) => {
                if (!manaCost) return '';
                return manaCost.replace(/\{([^}]+)\}/g, (match, symbol) => {
                    const manaSymbols = {
                        'W': 'âšª', 'U': 'ï¿½ï¿½', 'B': 'âš«', 'R': 'ðŸ”´', 'G': 'ðŸŸ¢',
                        'C': 'âšª', '1': '1', '2': '2', '3': '3', '4': '4', '5': '5',
                        '6': '6', '7': '7', '8': '8', '9': '9', '10': '10',
                        'X': 'X', 'Y': 'Y', 'Z': 'Z'
                    };
                    return manaSymbols[symbol] || symbol;
                });
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1><i className="fas fa-magic"></i> MTG Card Database</h1>
                        <p>Advanced search for Urza's Block through Invasion Block</p>
                    </div>

                    <div className="search-container">
                        <div className="search-header">
                            <i className="fas fa-search"></i>
                            <h2>Advanced Card Search</h2>
                        </div>
                        
                        <div className="search-content">
                            <div className="filter-grid">
                                {/* Card Name */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-tag"></i> Card Name</h3>
                                    <input
                                        type="text"
                                        className="search-input"
                                        placeholder="Enter card name..."
                                        value={filters.card_name}
                                        onChange={(e) => handleFilterChange('card_name', e.target.value)}
                                    />
                                </div>

                                {/* Sets */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-layer-group"></i> Sets</h3>
                                    <div className="multi-select">
                                        {availableFilters.sets?.map(set => (
                                            <label key={set.SetID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.sets.includes(set.SetID)}
                                                    onChange={(e) => handleMultiSelectChange('sets', set.SetID, e.target.checked)}
                                                />
                                                {set.SetName} ({set.SetCode})
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Colors */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-palette"></i> Colors</h3>
                                    <div className="multi-select">
                                        {availableFilters.colors?.map(color => (
                                            <label key={color.ColorID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.colors.includes(color.ColorID)}
                                                    onChange={(e) => handleMultiSelectChange('colors', color.ColorID, e.target.checked)}
                                                />
                                                {color.Color}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Rarities */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-gem"></i> Rarities</h3>
                                    <div className="multi-select">
                                        {availableFilters.rarities?.map(rarity => (
                                            <label key={rarity.RarityID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.rarities.includes(rarity.RarityID)}
                                                    onChange={(e) => handleMultiSelectChange('rarities', rarity.RarityID, e.target.checked)}
                                                />
                                                {rarity.RarityName}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Card Types */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-cards-blank"></i> Card Types</h3>
                                    <div className="multi-select">
                                        {availableFilters.card_types?.map(type => (
                                            <label key={type.CardTypeID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.card_types.includes(type.CardTypeID)}
                                                    onChange={(e) => handleMultiSelectChange('card_types', type.CardTypeID, e.target.checked)}
                                                />
                                                {type.TypeName}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Subtypes */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-tags"></i> Subtypes</h3>
                                    <div className="multi-select">
                                        {availableFilters.subtypes?.map(subtype => (
                                            <label key={subtype.SubTypeID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.subtypes.includes(subtype.SubTypeID)}
                                                    onChange={(e) => handleMultiSelectChange('subtypes', subtype.SubTypeID, e.target.checked)}
                                                />
                                                {subtype.SubTypeName}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Artists */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-paint-brush"></i> Artists</h3>
                                    <div className="multi-select">
                                        {availableFilters.artists?.map(artist => (
                                            <label key={artist.ArtistID}>
                                                <input
                                                    type="checkbox"
                                                    checked={filters.artists.includes(artist.ArtistID)}
                                                    onChange={(e) => handleMultiSelectChange('artists', artist.ArtistID, e.target.checked)}
                                                />
                                                {artist.ArtistName}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Converted Mana Cost */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-coins"></i> Converted Mana Cost</h3>
                                    <div className="range-inputs">
                                        <input
                                            type="number"
                                            placeholder="Min CMC"
                                            value={filters.cmc_min}
                                            onChange={(e) => handleFilterChange('cmc_min', e.target.value)}
                                        />
                                        <span>to</span>
                                        <input
                                            type="number"
                                            placeholder="Max CMC"
                                            value={filters.cmc_max}
                                            onChange={(e) => handleFilterChange('cmc_max', e.target.value)}
                                        />
                                    </div>
                                </div>

                                {/* Power/Toughness */}
                                <div className="filter-group">
                                    <h3><i className="fas fa-fist-raised"></i> Power/Toughness</h3>
                                    <div className="range-inputs">
                                        <input
                                            type="number"
                                            placeholder="Min Power"
                                            value={filters.power_min}
                                            onChange={(e) => handleFilterChange('power_min', e.target.value)}
                                        />
                                        <span>to</span>
                                        <input
                                            type="number"
                                            placeholder="Max Power"
                                            value={filters.power_max}
                                            onChange={(e) => handleFilterChange('power_max', e.target.value)}
                                        />
                                    </div>
                                    <div className="range-inputs" style="margin-top: 10px">
                                        <input
                                            type="number"
                                            placeholder="Min Toughness"
                                            value={filters.toughness_min}
                                            onChange={(e) => handleFilterChange('toughness_min', e.target.value)}
                                        />
                                        <span>to</span>
                                        <input
                                            type="number"
                                            placeholder="Max Toughness"
                                            value={filters.toughness_max}
                                            onChange={(e) => handleFilterChange('toughness_max', e.target.value)}
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="search-actions">
                                <button className="btn btn-primary" onClick={performSearch} disabled={loading}>
                                    <i className="fas fa-search"></i>
                                    {loading ? 'Searching...' : 'Search Cards'}
                                </button>
                                <button className="btn btn-secondary" onClick={clearFilters}>
                                    <i className="fas fa-eraser"></i>
                                    Clear Filters
                                </button>
                                <button className="btn btn-secondary" onClick={() => setShowSqlPreview(!showSqlPreview)}>
                                    <i className="fas fa-code"></i>
                                    {showSqlPreview ? 'Hide' : 'Show'} SQL Preview
                                </button>
                            </div>

                            {showSqlPreview && (
                                <div className="sql-preview">
                                    <strong>Generated SQL Query:</strong>
                                    <br />
                                    SELECT DISTINCT c.CardID, c.CardName, c.ManaCost, c.ConvertedManaCost, 
                                    c.Abilities, c.FlavorText, c.Power, c.Toughness, c.ImageURL, c.Layout, 
                                    c.SuperType, a.ArtistName, r.RarityName, s.SetName, s.SetCode, s.ReleaseDate,
                                    GROUP_CONCAT(DISTINCT col.Color) as Colors,
                                    GROUP_CONCAT(DISTINCT ct.TypeName) as CardTypes,
                                    GROUP_CONCAT(DISTINCT st.SubTypeName) as SubTypes
                                    FROM Card c
                                    JOIN Artist a ON c.ArtistID = a.ArtistID
                                    JOIN Rarity r ON c.RarityID = r.RarityID
                                    JOIN CardSet s ON c.SetID = s.SetID
                                    LEFT JOIN Card_Color cc ON c.CardID = cc.CardID
                                    LEFT JOIN Color col ON cc.ColorID = col.ColorID
                                    LEFT JOIN Card_CardType cct ON c.CardID = cct.CardID
                                    LEFT JOIN CardType ct ON cct.CardTypeID = ct.CardTypeID
                                    LEFT JOIN Card_SubType cst ON c.CardID = cst.CardID
                                    LEFT JOIN SubType st ON cst.SubTypeID = st.SubTypeID
                                    {Object.keys(filters).some(key => filters[key] && filters[key].length > 0) && 
                                        `WHERE ${Object.entries(filters)
                                            .filter(([key, value]) => value && value.length > 0)
                                            .map(([key, value]) => {
                                                if (key === 'card_name') return `c.CardName LIKE '%${value}%'`;
                                                if (key === 'cmc_min') return `c.ConvertedManaCost >= ${value}`;
                                                if (key === 'cmc_max') return `c.ConvertedManaCost <= ${value}`;
                                                if (key === 'power_min') return `CAST(c.Power AS REAL) >= ${value}`;
                                                if (key === 'power_max') return `CAST(c.Power AS REAL) <= ${value}`;
                                                if (key === 'toughness_min') return `CAST(c.Toughness AS REAL) >= ${value}`;
                                                if (key === 'toughness_max') return `CAST(c.Toughness AS REAL) <= ${value}`;
                                                if (Array.isArray(value) && value.length > 0) {
                                                    return `${key.replace('s', '')}ID IN (${value.join(',')})`;
                                                }
                                                return '';
                                            })
                                            .filter(condition => condition)
                                            .join(' AND ')}`
                                    }
                                    GROUP BY c.CardID ORDER BY c.CardName LIMIT {filters.limit}
                                </div>
                            )}
                        </div>
                    </div>

                    {error && (
                        <div className="error">
                            <i className="fas fa-exclamation-triangle"></i> {error}
                        </div>
                    )}

                    {loading && (
                        <div className="loading">
                            <i className="fas fa-spinner"></i>
                            <p>Searching for cards...</p>
                        </div>
                    )}

                    {searchResults.length > 0 && (
                        <div className="results-container">
                            <div className="results-header">
                                <div className="results-count">
                                    Found {totalResults} cards
                                </div>
                            </div>
                            
                            <div className="cards-grid">
                                {searchResults.map(card => (
                                    <div key={card.CardID} className="card">
                                        <div className="card-image">
                                            {card.ImageURL ? (
                                                <img src={card.ImageURL} alt={card.CardName} />
                                            ) : (
                                                <div>
                                                    <i className="fas fa-image" style="font-size: 3rem; margin-bottom: 10px"></i>
                                                    <br />
                                                    No Image Available
                                                </div>
                                            )}
                                        </div>
                                        <div className="card-content">
                                            <div className="card-name">{card.CardName}</div>
                                            <div className="card-mana">{formatManaCost(card.ManaCost)}</div>
                                            <div className="card-type">{card.CardTypes}</div>
                                            <div className="card-set">{card.SetName} ({card.SetCode})</div>
                                            <span className={`card-rarity ${getRarityClass(card.RarityName)}`}>
                                                {card.RarityName}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<MTGSearchApp />, document.getElementById('root'));
    </script>
</body>
</html>
